<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking</title>
    <link rel="stylesheet" href="./main.css">
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <div class="sign">
        <h1 style="text-shadow: 2px 2px black;">Banking</h1>
        <button id="create" class="button-38">Create a bank</button><br><br>
        <button id="bank" class="button-38">Access your banking</button>
    </div>

    <script type="module">
            // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-analytics.js";
        import { getDatabase, set, ref, get, child, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.12.1/firebase-database.js"
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBlgCt1yJFfwKguVfymD5s1uB98Y3mcL2U",
            authDomain: "burt-coin.firebaseapp.com",
            projectId: "burt-coin",
            storageBucket: "burt-coin.appspot.com",
            messagingSenderId: "942203765915",
            appId: "1:942203765915:web:ce50f6f18a90216bce723e",
            measurementId: "G-5CD9ZFYH8K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        const dbref = ref(db);
        $("#create").click(function() {
            if(window.localStorage.getItem("social") < 700) {
                alert("your social creadit score is too low (must be > 700)")
            }
            else {
                let yes = prompt("Type yes to conform");
                if(yes !== "yes") {
                    alert("Will not contunie")
                }
                else {
                    let name = prompt("Enter your bank name (1/3)");
                    let password = prompt("Enter what password you want to use (2/3)");
                    let balance = prompt("How much does your bank need? (3/3)");
                    if(balance > 10000) {
                        alert("You dont need that kind of money");
                    }
                    else {
                        get(child(dbref, "banks/" + name + "/")).then(function(snapshot) {
                            if(snapshot.exists()) {
                                alert("This bank name already exists");
                            }
                            else {
                                set(ref(db, "banks/" + name), {
                                    name: name,
                                    password: password,
                                    balance: balance,
                                    id: Math.floor(Math.random() * 1000) + 1,
                                    owner: window.localStorage.getItem("username"),
                                    pin: 1234

                                });
                                window.localStorage.setItem("bank", name);
                                setTimeout(function() {
                                    window.location.href = "./bankv.html";
                                }, 500)
                            }
                        });
                        
                    }
                }
            }
        });
        function loan() {
            let name = prompt("Enter your bank name (1/4)");
            let accountName = prompt("Enter your account name (2/4)");
            let password = prompt("Enter your password (3/4)");
            let amount = prompt("How much do you want to loan? (4/4)");
            get(child(dbref, "banks/" + name + "/" + "users/" + accountName)).then(function(snapshot) {
                if(snapshot.exists()) {
                    if(snapshot.val().password !== password) {
                        alert("Wrong password");
                    }
                    else {
                                let yes = prompt("Type yes to conform");
                                if(yes !== "yes") {
                                    alert("Will not contunie")
                                }
                                else {
                                    let newbalance = snapshot.val().balance - amount;
                                    update(ref(db, "banks/" + name), {
                                        balance: newbalance
                                    });
                                    let newbalance2 = parseInt(window.localStorage.getItem("balance")) + parseInt(amount);
                                    window.localStorage.setItem("balance", newbalance2);
                                    update(ref(db, "banks/" +  name + "/" + "users/" + window.localStorage.getItem("an")), {
                                        balance: newbalance2
                                    });
                                    alert("You have been loaned " + amount + " coins");
                                }
                            }
                        
                    
                }
                else {
                    alert("This bank name does not exist");
                }
            });
        }
        // get bank vars
        $("#bank").click(function() {
            let name = prompt("Enter the bank name");
            let action = prompt("What do you want to do? (loan, transfer coins to main account (tma), get Acount (ga), get balance (gb)");
            get(child(dbref, "banks/" + name + "/")).then(function(snapshot) {
                if(snapshot.exists()) {  
                   if(action == "loan") {
                    loan();
                   }
                
                 if(action == "ga") {
                  let bankuse = prompt("Enter the bank name you want to get the acount of");
                  let an = prompt("Enter a name you want to use for your account");
                  let password = prompt("Enter the password you want to use");
                  get(child(dbref, "banks/" + bankuse + "/" + "users/" + an + "/")).then(function(snapshot) {
                      if(snapshot.exists()) {
                          alert("This account name already exists");
                      }
                      else {
                          set(ref(db, "banks/" + bankuse + "/" + "users/" + an ), {
                              name: an,
                              password: password,
                              balance: 0
                          });
                          window.localStorage.setItem("an", an);
                          alert("You have created an account");
                      }
                  });
                }
                 if(action == "tma") {
                    let bank = prompt("Enter your bank name");
                    let amount = prompt("How much do you want to transfer?");
                    let name = prompt("enter your bank username");
                    let password = prompt("Enter your password");
                    get(child(dbref, "banks/" + bank + "/" + "users/" + name)).then(function(snapshot) {
                        if(snapshot.exists()) {
                            if(snapshot.val().password !== password) {
                                alert("Wrong password");
                            }
                            else {
                                if(snapshot.val().balance < amount) {
                                    alert("You dont have that much money");
                                }
                                else {
                                    let newbalance = snapshot.val().balance - amount;
                                    update(ref(db, "banks/" + bank), {
                                        balance: newbalance
                                    });
                                    let newbalance2 = parseInt(window.localStorage.getItem("balance")) + parseInt(amount);
                                    window.localStorage.setItem("balance", newbalance2);
                                    update(ref(db, "users/" + window.localStorage.getItem("username")), {
                                        balance: newbalance2
                                    });
                                    alert("You have transfered " + amount + " coins to your main account");
                                }
                            }
                        
                        }
                    
                 });
                 }
                
            }
              if(action == "gb") {
                // get balance
                let bankName = prompt("Enter the bank name");
                let name = prompt("Enter your bank username");
                     get(child(dbref, "banks/" + bankName + "/" + "users/" + name)).then(function(snapshot) {
                    if(snapshot.exists()) {
                        alert("Your balance is " + snapshot.val().balance);
                    }
                    else {
                        alert("You dont have an account");
                    }
                });
            }
            else {
                    alert("This bank does not exist");
                }
                
            });
        
           
        });

    </script>
    <style>
        body {
            overflow: scroll;
            height: inherit;
        }
        .sign {
            width: 30%;
            height: 50%;
            background-color: rgb(43, 43, 143);
            margin-left: 25%;
            margin-top: 15%;
            padding: 10%;
            text-align: left;
        }
    </style>
</body>
</html>
